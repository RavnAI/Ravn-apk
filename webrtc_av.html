<!doctype html><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>WebRTC AV</title>
<style>
  body{background:#0b0f14;color:#e7ffe7;font:16px system-ui,sans-serif;margin:16px}
  input,button{padding:8px 12px;border-radius:10px;border:1px solid #2dd36f;background:#122018;color:#d6ffe0}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:10px 0}
  video{width:100%;max-width:480px;background:#000;border-radius:12px;border:1px solid #264}
  #log{white-space:pre-wrap;background:#0c141a;border:1px solid #264;padding:10px;border-radius:10px;max-height:30vh;overflow:auto}
</style>
<h1>WebRTC lyd + video</h1>
<div class="row">
  Rom: <input id="room" value="test" size="14">
  <button id="join">Join</button>
  <button id="start">Start call</button>
  <button id="hang">Hang up</button>
  <span id="state"></span>
</div>
<div class="row">
  <div>
    <div>Lokalt</div>
    <video id="local" playsinline muted autoplay></video>
  </div>
  <div>
    <div>Fjern</div>
    <video id="remote" playsinline autoplay></video>
  </div>
</div>
<div id="log">Gi nettleseren tilgang til kamera + mikrofon når den spør.</div>
<script>
const $=id=>document.getElementById(id);
let pc, ws, localStream;
const wsURL = 'ws://'+(location.hostname||'127.0.0.1')+':8765';

function log(...a){ const l=$('log'); l.textContent += "\n"+a.join(' '); l.scrollTop=l.scrollHeight; }
function setState(s){ $('state').textContent=s; }

async function setupMedia(){
  if(localStream) return localStream;
  localStream = await navigator.mediaDevices.getUserMedia({audio:true, video:true});
  $('local').srcObject = localStream;
  return localStream;
}

async function ensurePC(){
  if(pc) return pc;
  pc = new RTCPeerConnection({iceServers:[]});
  pc.onconnectionstatechange = ()=> setState('PC: '+pc.connectionState);
  pc.onicecandidate = e=>{
    if(e.candidate && ws && ws.readyState===1){
      ws.send(JSON.stringify({type:'ice', room:$('room').value.trim()||'test', payload:e.candidate}));
    }
  };
  pc.ontrack = e => { $('remote').srcObject = e.streams[0]; };
  (await setupMedia()).getTracks().forEach(t=>pc.addTrack(t, localStream));
  return pc;
}

function connectWS(){
  return new Promise((resolve,reject)=>{
    ws = new WebSocket(wsURL);
    ws.onopen = ()=>{ setState('Signal OK'); resolve(); };
    ws.onerror = reject;
    ws.onmessage = async ev=>{
      const m = JSON.parse(ev.data||'{}');
      const room = $('room').value.trim()||'test';
      if(m.type==='offer'){
        await ensurePC();
        await pc.setRemoteDescription(m.payload);
        const ans = await pc.createAnswer(); await pc.setLocalDescription(ans);
        ws.send(JSON.stringify({type:'answer', room, payload:pc.localDescription}));
      }else if(m.type==='answer'){
        if(pc) await pc.setRemoteDescription(m.payload);
      }else if(m.type==='ice'){
        try{ if(pc) await pc.addIceCandidate(m.payload); }catch{}
      }
    };
  });
}

$('join').onclick = async ()=>{
  try{ await connectWS(); log('Joined signal'); }catch(e){ log('WS error',e); }
};

$('start').onclick = async ()=>{
  try{
    await ensurePC();
    // er vi først: lag offer
    const offer = await pc.createOffer(); await pc.setLocalDescription(offer);
    const room = $('room').value.trim()||'test';
    ws.send(JSON.stringify({type:'offer', room, payload:offer}));
    log('Offer sendt');
  }catch(e){ log('Start-feil',e); }
};

$('hang').onclick = ()=>{
  try{ pc&&pc.close(); }catch{}
  pc=null;
  try{ ws&&ws.close(); }catch{}
  ws=null;
  setState('Avsluttet');
  log('Call avsluttet');
};
</script>
